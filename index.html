<!DOCTYPE html>
<html>
  <head>
    <!-- <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" /> -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
      integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
      integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
      crossorigin=""
    ></script>
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans&amp;display=swap"
      rel="stylesheet"
    />
    <style>
      main {
        display: flex;
        flex-direction: column;
        margin: 20px auto;
        max-width: 1500px;
        color: #444;
        padding: 0 25px;
        font-family: "Open Sans", sans-serif !important;
        position: relative;
      }

      #map {
        width: 100%;
        height: 80vh;
      }

      #legend {
        display: flex;
        flex-direction: column;
      }

      .triangle {
        border: 1px solid rgba(255, 255, 255, 0.2);
        height: inherit;
        width: inherit;
        display: inherit;
        transform: rotate(180deg);
      }

      .circle-1 {
        border-radius: 16px;
        display: inline-block;
        margin-right: 0.3rem;
        margin-left: 0.05rem;
        /* border: 1px solid #fff; */
      }

      .circle-2 {
        border-radius: 16px;
        display: inline-block;
        margin-right: 0.5rem;
        margin-left: 0.3rem;
        margin-bottom: 0.2em;
        /* border: 1px solid #fff; */
      }

      .leaflet-popup-content p {
        margin: 0.5rem 0;
      }

      .not-highlight {
        background-color: #ff214f;
        color: white;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="legend">
        <label class="checkbox"
          ><input type="checkbox" checked data-layer="isInProgram" />
          <span
            style="background-color: #084eff; width: 0.8em; height: 0.8em"
            class="circle-1"
          ></span
          >Schoolyard in program</label
        >

        <label class="checkbox"
          ><input type="checkbox" checked data-layer="notInProgram" />
          <span style="width: 0.8em; height: 0.8em">
            <svg class="triangle" viewBox="0 0 100 100">
              <polygon fill="#f9466b" points="50 15, 100 100, 0 100" />
            </svg> </span
          >Schoolyard in <strong>NOT</strong> program</label
        >

        <label class="checkbox"
          ><input type="checkbox" data-layer="playgrounds" />
          <span
            style="background-color: #007600; width: 0.4em; height: 0.4em"
            class="circle-2"
          ></span
          >NYC Parks Playground</label
        >
      </div>
      <div id="map"></div>
    </main>

    <script src="data/isInProgram_0.js"></script>
    <script src="data/hasSchoolYardNotInProgramActual_3.js"></script>
    <script src="data/playgrounds_coords_7.js"></script>
    <script>
      // ASK ZHI-- not sure what's wrong with this code but something is breaking the map from loading
      // is it because I didn't return map at the end?

      //ZHI: you need to init mapContainer so
      //   const mapContainer = document.getElementById('map')
      // const settings = {
      // maxZoom: 20,
      // minZoom: 11,
      // bounds: L.latLngBounds([40.496133, -74.2555913], [40.9155327, -73.30078125])
      // };

      // const map = L.map(mapContainer, { ...settings }).setView([40.67, -73.85], 11);

      // L.tileLayer(
      // 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png',
      // {
      //     ...settings,
      //     attribution:
      //     'Carto | &copy; <a href="http://osm.org/copyright">OSM</a> contributors'
      // }
      // ).addTo(map);

      const map = L.map("map").setView([40.7831, -73.949], 13);

      let baseMap = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 20,
          minZoom: 11,
          bounds: L.latLngBounds(
            [40.496133, -74.5555913],
            [40.9155327, -73.30078125]
          ),
          attribution:
            'Carto | &copy; <a href="http://osm.org/copyright">OSM</a> contributors',
        }
      ).addTo(map);

      // you can't see them markers with this code
      function createTriangleMarker(feature, latlng) {
        const icon = L.divIcon({
          className: "leaflet-icon",
          html: `<svg class="triangle" viewBox="0 0 100 100">
            	<polygon fill="#f9466b" points="50 15, 100 100, 0 100"/>
                </svg>`,
          iconSize: [12, 12],
          iconAnchor: [0, 0],
        });
        return L.marker(latlng, { icon });
      }

      // let layer = L.geoJSON(json_isInProgram_0.features, {
      //     pointToLayer: createMarker,
      //         onEachFeature: (feature, layer) => {
      //             if (feature.properties && feature.properties.label) {
      //                 layer.bindPopup(feature.properties.label, {
      //                     closeButton: false,
      //                     autoPan: false,
      //                     offset: L.point(0, 0)
      //                 });
      //             }
      //         }
      //     }).addTo(map);

      let isInProgramMarkerStyle = {
        radius: 5,
        fillColor: "#084eff",
        color: "#000",
        weight: 0,
        opacity: 1,
        fillOpacity: 0.8,
      };

      let playgroundsMarkerStyle = {
        radius: 2,
        fillColor: "#007600",
        color: "#000",
        weight: 0,
        opacity: 1,
        fillOpacity: 0.8,
      };

      function createSchoolPopup(feature, layer) {
        if (feature.properties && feature.properties.Primary_Address) {
          return layer.bindPopup(
            `<h4>${feature.properties.Buidling_Name}</h4>
                <p><a target="_blank" href="http://maps.google.com/?q=${
                  feature.properties.Primary_Address
                };near=new+york">${feature.properties.Primary_Address}</a></p>
                ${
                  +feature.properties.isInProgram
                    ? "<p>A part of the Schoolyards to Playgrounds program</p>"
                    : "<p><span class='not-highlight'>NOT</span> a part of the Schoolyards to Playgrounds program</p>"
                }
                `,
            {
              autoPan: false,
              offset: L.point(0, 0),
            }
          );
        }
      }

      let isInProgram = L.geoJSON(json_isInProgram_0.features, {
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, isInProgramMarkerStyle);
        },
        onEachFeature: createSchoolPopup,
      }).addTo(map);

      let notInProgram = L.geoJSON(json_hasSchoolYardNotInProgramActual_3, {
        pointToLayer: createTriangleMarker,
        onEachFeature: createSchoolPopup,
      }).addTo(map);

      let playgrounds = L.geoJSON(json_playgrounds_coords_7, {
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, playgroundsMarkerStyle);
        },
        onEachFeature: (feature, layer) => {
          if (feature.properties && feature.properties.Name) {
            layer.bindPopup(feature.properties.Name, {
              autoPan: false,
              offset: L.point(0, 0),
            });
          }
        },
      }); //.addTo(map);

      let baseMaps = {
        "Carto Base Map": baseMap,
      };

      let overlayMaps = {
        isInProgram: isInProgram,
        notInProgram: notInProgram,
        playgrounds: playgrounds,
      };

      //   let layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

      //logic for legend inputs
      const inputs = document.querySelectorAll("#legend input");

      //reset inputs - refreshing doesn't reset them
      Array.from(inputs).forEach((input) => {
        const layer = input.dataset.layer;
        if (layer !== "playgrounds") {
          input.checked = true;
        } else {
          input.checked = false;
        }
      });

      //for each input add listen for change to toggle based on checked
      Array.from(inputs).forEach((input) => {
        input.addEventListener("change", (e) => {
          const checked = e.target.checked;
          const layer = overlayMaps[e.target.dataset.layer];
          checked ? map.addLayer(layer) : map.removeLayer(layer);
        });
      });
    </script>
  </body>
</html>
